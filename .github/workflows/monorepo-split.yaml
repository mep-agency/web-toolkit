name: 'Packages Split'

on:
  push:
    branches:
      - main
    tags:
      - '*'
    paths:
      - .github/workflows/monorepo-split.yaml
      - composer/**
      - npm/**

env:
  GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

jobs:
  packages_split:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        # define package to repository map
        package:
          # Composer
          - local_path: composer/packages/mwt-k8s-cli
            split_repository: mwt-k8s-cli
          - local_path: composer/packages/web-toolkit-bundle
            split_repository: web-toolkit-bundle
          - local_path: composer/projects/mwt-k8s-cli-skeleton
            split_repository: mwt-k8s-cli-skeleton
          - local_path: composer/projects/symfony-web-toolkit-skeleton
            split_repository: symfony-web-toolkit-skeleton

          # NPM
          - local_path: npm/web-toolkit-front-end
            split_repository: web-toolkit-front-end

          # GitHub
          - local_path: github/web-toolkit-workflows
            split_repository: web-toolkit-workflows

    steps:
      -   uses: actions/checkout@v2

      # no tag
      -
        if: '!startsWith(github.ref, ''refs/tags/'')'
        uses: symplify/monorepo-split-github-action@2.1
        with:
          package_directory: ${{ matrix.package.local_path }}
          repository_organization: 'mep-agency'
          repository_name: ${{ matrix.package.split_repository }}

          user_name: GitHub Action
          user_email: action@github.com

      # with tag
      -
        if: startsWith(github.ref, 'refs/tags/')
        uses: symplify/monorepo-split-github-action@2.1
        with:
          tag: ${GITHUB_REF#refs/tags/}

          package_directory: ${{ matrix.package.local_path }}
          repository_organization: 'mep-agency'
          repository_name: ${{ matrix.package.split_repository }}

          user_name: GitHub Action
          user_email: action@github.com
